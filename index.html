<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>2çŠ¶æ…‹DESã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ (LiteGraph.js, 1ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆ)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/litegraph.js/0.7.13/css/litegraph.min.css">
<style>
  html,body{height:100%;margin:0;background:#0f1115;color:#e6e6e6;font-family:system-ui,Segoe UI,Helvetica,Arial,sans-serif;}
  #app{display:grid;grid-template-columns:1fr 340px;height:100%;}
  #graph{position:relative;background:#1b1f2a;}
  #controls{padding:12px;border-left:1px solid #2a3142;display:flex;flex-direction:column;gap:12px}
  #controls h2{margin:0 0 2px;font-size:18px;color:#b6c3ff}
  .row{display:flex;flex-wrap:wrap;gap:8px}
  button,select,input[type="number"],input[type="text"]{
    background:#22293a;border:1px solid #3a4157;color:#e6e6e6;border-radius:8px;padding:8px 10px;font-size:13px
  }
  button:hover{filter:brightness(1.06)}
  button.primary{background:#4158d0;border-color:#5670ff}
  button.warn{background:#8a2b2b;border-color:#b23f3f}
  .card{background:#161a24;border:1px solid #2a3142;border-radius:12px;padding:10px}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace}
  #stats table{width:100%;font-size:12px;border-collapse:collapse}
  #stats td{padding:4px 0;border-bottom:1px dashed #2a3142}
  #footer{opacity:.7;font-size:12px}
  .hint{opacity:.8;font-size:12px;line-height:1.5}
  .badge{display:inline-block;border:1px solid #3a4157;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:11px;background:#1c2230}
</style>
</head>
<body>
<div id="app">
  <div id="graph">
    <canvas id="graphcanvas"></canvas>
  </div>
  <div id="controls">
    <div class="card">
      <h2>å®Ÿè¡Œ</h2>
      <div class="row">
        <button id="btnRun" class="primary">â–¶ èµ°ã‚‰ã›ã‚‹</button>
        <button id="btnPause">â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="btnReset" class="warn">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="row" style="margin-top:6px">
        <label>åœ°å¹³ç·š H[s]: <input id="horizon" type="number" min="1" value="600" style="width:90px"></label>
        <label>å€é€Ÿ: <select id="speed">
          <option value="1">Ã—1</option>
          <option value="5">Ã—5</option>
          <option value="20">Ã—20</option>
          <option value="100" selected>Ã—100</option>
          <option value="1000">Ã—1000</option>
        </select></label>
      </div>
    </div>

    <div class="card">
      <h2>ã‚°ãƒ©ãƒ•</h2>
      <div class="row">
        <button id="btnCompile">ğŸ”§ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«</button>
        <button id="btnSave">ğŸ’¾ ä¿å­˜</button>
        <button id="btnLoad">ğŸ“‚ èª­è¾¼</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button id="btnSampleLine">ã‚µãƒ³ãƒ—ãƒ«ï¼šç›´åˆ—</button>
        <button id="btnSampleBranch">ã‚µãƒ³ãƒ—ãƒ«ï¼šåˆ†å²</button>
        <button id="btnSampleJoin">ã‚µãƒ³ãƒ—ãƒ«ï¼šåˆæµ</button>
      </div>
      <div class="hint" style="margin-top:8px">
        ãƒ»ãƒãƒ¼ãƒ‰ã¯å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒAdd Nodeã€ã‹ã‚‰è¿½åŠ ï¼ˆsim/ ä»¥ä¸‹ï¼‰<br>
        ãƒ»Station ã® <span class="badge">routing</span> ã¯ <b>roundrobin</b> / <b>random</b><br>
        ãƒ»Join2 ã¯ 2å…¥åŠ›ANDåˆæµã€`tauP`/`tauT` ã‚’æŒã¤å·¥ç¨‹ã¨ã—ã¦æ‰±ã„ã¾ã™
      </div>
    </div>

    <div id="stats" class="card">
      <h2>çµ±è¨ˆ</h2>
      <table>
        <tr><td>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿æ™‚åˆ»</td><td class="mono" id="st_time">0.00 s</td></tr>
        <tr><td>å®Œäº†æ•°ï¼ˆSinkï¼‰</td><td class="mono" id="st_done">0</td></tr>
        <tr><td>ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆï¼ˆå®Ÿæ¸¬ï¼‰</td><td class="mono" id="st_q">0 /s</td></tr>
        <tr><td>WIPï¼ˆåœ¨åˆ¶å“/å æœ‰æ•°ï¼‰</td><td class="mono" id="st_wip">0</td></tr>
        <tr><td>ãƒœãƒˆãƒ«ãƒãƒƒã‚¯æ¨å®š Ï„<sub>max</sub></td><td class="mono" id="st_bneck">-</td></tr>
      </table>
    </div>

    <div id="footer" class="hint">
      <b>2çŠ¶æ…‹ï¼ˆP/Tï¼‰ãƒ¢ãƒ‡ãƒ«</b>ï¼š<br>
      P = ã€Œå‰å·¥ç¨‹ã‹ã‚‰æ¬é€é–‹å§‹ â†’ å¾Œå·¥ç¨‹å¾…ã¡ã€<br>
      T = ã€Œå¾Œå·¥ç¨‹ã¸ã®æ¬é€é–‹å§‹ â†’ å‰å·¥ç¨‹å¾…ã¡ã€<br>
      å¾…ã¡æ™‚é–“ã‚’åŠã‚µã‚¤ã‚¯ãƒ«ã«å†…åŒ…ã—ã€å·¥ç¨‹Ã—2å€‹ã®çŠ¶æ…‹ã§ç°¡æ½”ã«è¡¨ç¾ã—ã¾ã™ã€‚
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/litegraph.js/0.7.13/build/litegraph.min.js"></script>
<script>
/* ============================================================
   2çŠ¶æ…‹DES ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒ»ç°¡æ½”å®Ÿè£…ï¼‰
   ------------------------------------------------------------
   - Token: {id, birth}
   - Entities: Source, Station, Join2, Sink
   - Station: capacity=1, Pâ†’Tâ†’deliver(å¯èƒ½ãªã‚‰å³æ™‚ã€ä¸å¯ãªã‚‰å¾…æ©Ÿ)
   - deliverå¾…æ©Ÿ: targetã‚­ãƒ¥ãƒ¼ã«ç©ã‚“ã§ã€targetãŒç©ºã„ãŸã‚‰å–ã‚Šå‡ºã—
   ============================================================ */

// ---------- å°é“å…· ----------
const fmt = (x, d=2)=> (typeof x==='number' ? x.toFixed(d) : String(x));
let UID = 1; const nextId = ()=> UID++;

// ---------- äº‹ä»¶ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ© ----------
class Scheduler {
  constructor(){ this.t=0; this.events=[]; this.running=false; this.horizon=600; }
  clear(){ this.t=0; this.events.length=0; this.running=false; }
  schedule(at, fn, tag=""){ this.events.push({at, fn, tag}); this.events.sort((a,b)=>a.at-b.at); }
  step(maxEvents=1000){
    let n=0;
    while(n<maxEvents && this.events.length && this.t <= this.horizon){
      const e = this.events.shift();
      this.t = e.at; e.fn(this);
      n++;
    }
    return n;
  }
}

// ---------- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“ ----------
class Simulation {
  constructor(){ 
    this.sched = new Scheduler();
    this.entities = new Map(); // id -> entity
    this.waitQ = new Map();    // targetId -> [{from, token}]
    this.done = 0;
  }
  reset(){
    this.sched.clear();
    this.waitQ.clear();
    this.done = 0;
    for(const e of this.entities.values()){ e.reset && e.reset(this); }
  }
  addEntity(e){ this.entities.set(e.id, e); }
  getEntity(id){ return this.entities.get(id); }

  deliverOrQueue(from, to, token){
    const target = (typeof to==='number') ? this.getEntity(to) : to;
    if(target.canAccept()){
      target.accept(token);
      from.onDelivered && from.onDelivered(); // ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ è§£é™¤
      return true;
    }else{
      if(!this.waitQ.has(target.id)) this.waitQ.set(target.id, []);
      this.waitQ.get(target.id).push({from, token});
      from.onBlocked && from.onBlocked(target.id);
      return false;
    }
  }
  tryServeWaiters(targetId){
    const target = this.getEntity(targetId);
    const q = this.waitQ.get(targetId);
    if(!q || !q.length) return;
    if(!target.canAccept()) return;
    const {from, token} = q.shift();
    target.accept(token);
    from.onDelivered && from.onDelivered();
  }

  totalWIP(){
    let w=0;
    for(const e of this.entities.values()){ if(e.wip) w += e.wip(); }
    return w;
  }
}

// ---------- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åŸºåº• ----------
class Entity {
  constructor(sim, node){
    this.sim = sim; this.node = node; this.id = node?.id || nextId();
    this.out = []; // å‡ºåŠ›å…ˆ entity.id ã®é…åˆ—
  }
  canAccept(){ return true; }
  wip(){ return 0; }
  reset(){}
}

// ---------- Sourceï¼ˆä¸€å®šé–“éš”ã§ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼‰ ----------
class Source extends Entity {
  constructor(sim, node){
    super(sim, node);
    this.period = Number(node?.properties?.period || 5);
    this.burst  = Number(node?.properties?.burst  || 1);
    this.active = false;
    this.nextIndex = 0;
  }
  reset(){ this.active=false; }
  start(){
    this.active=true;
    const emit = ()=>{
      if(!this.active) return;
      for(let k=0;k<this.burst;k++){
        const token = {id: nextId(), birth: this.sim.sched.t};
        const to = this.pickNext();
        this.sim.deliverOrQueue(this, to, token);
      }
      this.sim.sched.schedule(this.sim.sched.t + this.period, emit, "source_emit");
    };
    this.sim.sched.schedule(this.sim.sched.t + 0.0001, emit, "source_start");
  }
  pickNext(){
    if(!this.out.length) return null;
    const idx = this.nextIndex % this.out.length;
    this.nextIndex++;
    return this.out[idx];
  }
  onDelivered(){}
  onBlocked(){}
}

// ---------- Sinkï¼ˆå®Œäº†ï¼‰ ----------
class Sink extends Entity{
  canAccept(){ return true; }
  accept(token){
    // å®Œäº†
    this.sim.done++;
  }
}

// ---------- Stationï¼ˆPâ†’Tã®2çŠ¶æ…‹, capacity=1ï¼‰ ----------
class Station extends Entity{
  constructor(sim, node){
    super(sim, node);
    this.tauP = Number(node?.properties?.tauP || 5);
    this.tauT = Number(node?.properties?.tauT || 3);
    this.routing = (node?.properties?.routing || "roundrobin").toLowerCase();
    this.state = "idle"; // idle | P | T | blocked
    this.token = null;
    this.nextIndex = 0;
    this.blockedTarget = null;
    this.lastTStart = 0;
  }
  reset(){ this.state="idle"; this.token=null; this.blockedTarget=null; }
  canAccept(){ return this.state==="idle"; }
  wip(){ return (this.state==="idle")?0:1; }

  accept(token){
    // é–‹å§‹: P
    this.state="P"; this.token=token;
    const t_end = this.sim.sched.t + this.tauP;
    this.sim.sched.schedule(t_end, ()=>this.onPdone(), "Pdone");
  }
  onPdone(){
    // æ¬¡: T
    this.state="T";
    this.lastTStart = this.sim.sched.t;
    const t_end = this.sim.sched.t + this.tauT;
    this.sim.sched.schedule(t_end, ()=>this.onTtryDeliver(), "Tdone");
  }
  chooseNext(){
    if(this.out.length===0) return null;
    if(this.routing==="random"){
      const idx = Math.floor(Math.random()*this.out.length);
      return this.out[idx];
    }else{ // roundrobin
      const idx = this.nextIndex % this.out.length; this.nextIndex++;
      return this.out[idx];
    }
  }
  onTtryDeliver(){
    const to = this.chooseNext();
    if(to==null){ // æ¥ç¶šãªã—â†’æ¨ã¦ã‚‹
      this.state="idle"; this.token=null;
      this.sim.tryServeWaiters(this.id); // è‡ªåˆ†ã«å¾…æ©Ÿã—ã¦ã‚‹ä¸ŠæµãŒã‚ã‚Œã°å—ã‘å…¥ã‚Œ
      return;
    }
    const ok = this.sim.deliverOrQueue(this, to, this.token);
    if(ok){
      // å—ã‘æ¸¡ã—å®Œäº†
      this.state="idle"; this.token=null;
      this.sim.tryServeWaiters(this.id);
    }else{
      // ä¸‹æµãŒç©ºã„ãŸã‚‰å–ã‚Šã«æ¥ã¦ã‚‚ã‚‰ã†ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ï¼‰
      this.state="blocked";
      this.blockedTarget = (typeof to==='number')?to:to.id;
    }
  }
  onBlocked(targetId){ /* NOP: å¯è¦–åŒ–ç”¨ã«ä¿æŒæ¸ˆã¿ */ }
  onDelivered(){
    // ä¸‹æµã«æ¸¡ã›ãŸ
    this.state="idle"; this.token=null; this.blockedTarget=null;
    this.sim.tryServeWaiters(this.id);
  }
}

// ---------- Join2ï¼ˆ2å…¥åŠ›ANDâ†’1å‡ºåŠ›, capacity=1ï¼‰ ----------
class Join2 extends Entity{
  constructor(sim, node){
    super(sim, node);
    this.tauP = Number(node?.properties?.tauP || 2);
    this.tauT = Number(node?.properties?.tauT || 1);
    this.buffer = new Set(); // å…¥åŠ›åˆ°ç€ã‚’ãƒãƒ¼ã‚¯ï¼ˆ2ã¤å¿…è¦ï¼‰
    this.state = "idle";
    this.token = null;       // å‡ºåŠ›ã¸æµã™â€œåˆæˆãƒˆãƒ¼ã‚¯ãƒ³â€
  }
  reset(){ this.buffer.clear(); this.state="idle"; this.token=null; }
  canAccept(){
    // 2ã¤ç›®ã¾ã§ã¯å—ã‘å–ã‚Œã‚‹ï¼ˆãŸã ã—è‡ªåˆ†ãŒåŠ å·¥ä¸­ãªã‚‰å¾…ã£ã¦ã‚‚ã‚‰ã†ï¼‰
    if(this.state!=="idle") return false;
    return this.buffer.size < 2;
  }
  wip(){ return (this.state==="idle")? (this.buffer.size>0?1:0) : 1; }

  accept(token){
    this.buffer.add(token.id); // å°ã®ã¿ï¼ˆä¸­èº«ã¯ä¸è¦ï¼‰
    if(this.buffer.size>=2 && this.state==="idle"){
      // Pé–‹å§‹
      this.state="P";
      this.buffer.clear();
      const t_end = this.sim.sched.t + this.tauP;
      this.sim.sched.schedule(t_end, ()=>this.onPdone(), "joinPdone");
    }
  }
  onPdone(){
    this.state="T";
    const t_end = this.sim.sched.t + this.tauT;
    this.sim.sched.schedule(t_end, ()=>this.onTtryDeliver(), "joinTdone");
  }
  onTtryDeliver(){
    if(!this.out.length){ this.state="idle"; return; }
    const to = this.out[0];
    const token = {id: nextId(), birth: this.sim.sched.t}; // åˆæµå¾Œã®1ãƒˆãƒ¼ã‚¯ãƒ³
    const ok = this.sim.deliverOrQueue(this, to, token);
    if(ok){
      this.state="idle";
      this.sim.tryServeWaiters(this.id);
    }else{
      this.state="blocked";
      this.blockedTarget = (typeof to==='number')?to:to.id;
    }
  }
  onDelivered(){ this.state="idle"; this.blockedTarget=null; this.sim.tryServeWaiters(this.id); }
}

// ---------- LiteGraph ãƒãƒ¼ãƒ‰å®šç¾© ----------
function registerLGNodes(){
  // Source
  function LGSource(){ this.addOutput("out"); this.properties={period:5, burst:1, title:"Source"}; }
  LGSource.title="Source"; LGSource.desc="ä¸€å®šé–“éš”ã§ãƒ¯ãƒ¼ã‚¯ç”Ÿæˆ";
  LGSource.prototype.onDrawForeground=function(ctx){ ctx.fillStyle="#9fe59f"; ctx.fillText("period="+this.properties.period+"s", 10, this.size[1]-8); }
  LiteGraph.registerNodeType("sim/Source", LGSource);

  // Station
  function LGStation(){
    this.addInput("in");
    this.addOutput("out", LiteGraph.EVENT); // è¤‡æ•°æ¥ç¶šOK
    this.widgets_up = true;
    this.properties={tauP:5,tauT:3,routing:"roundrobin", title:"Station"};
    this.addWidget("number","tauP",this.properties.tauP,"tauP");
    this.addWidget("number","tauT",this.properties.tauT,"tauT");
    this.addWidget("combo","routing",this.properties.routing,"routing",{values:["roundrobin","random"]});
  }
  LGStation.title="Station"; LGStation.desc="Pâ†’Tã®2çŠ¶æ…‹å·¥ç¨‹";
  LGStation.prototype.onDrawForeground=function(ctx){
    ctx.fillStyle="#b6c3ff";
    ctx.fillText(`P=${this.properties.tauP}s T=${this.properties.tauT}s`, 10, this.size[1]-8);
  }
  LiteGraph.registerNodeType("sim/Station", LGStation);

  // Join2
  function LGJoin2(){
    this.addInput("in1"); this.addInput("in2");
    this.addOutput("out");
    this.properties={tauP:2,tauT:1,title:"Join2(AND)"};
    this.addWidget("number","tauP",this.properties.tauP,"tauP");
    this.addWidget("number","tauT",this.properties.tauT,"tauT");
  }
  LGJoin2.title="Join2"; LGJoin2.desc="2å…¥åŠ›ANDåˆæµâ†’1å‡ºåŠ›";
  LGJoin2.prototype.onDrawForeground=function(ctx){
    ctx.fillStyle="#ffd28a";
    ctx.fillText(`Ï„P=${this.properties.tauP} Ï„T=${this.properties.tauT}`, 10, this.size[1]-8);
  }
  LiteGraph.registerNodeType("sim/Join2", LGJoin2);

  // Sink
  function LGSink(){ this.addInput("in"); this.properties={title:"Sink"}; }
  LGSink.title="Sink"; LGSink.desc="å®Œæˆã‚«ã‚¦ãƒ³ãƒˆ";
  LiteGraph.registerNodeType("sim/Sink", LGSink);
}

// ---------- LiteGraph ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ----------
const canvas = new LGraphCanvas("#graphcanvas");
const graph = new LGraph();
canvas.graph = graph;
canvas.ds.scale = 1.1;
registerLGNodes();

// ---------- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³â‡„ã‚°ãƒ©ãƒ•ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ« ----------
function compileGraph(sim){
  sim.entities.clear();
  // 1) ãƒãƒ¼ãƒ‰ç”Ÿæˆ
  for(const n of graph._nodes){
    if(n.type === "sim/Source"){ sim.addEntity(new Source(sim, n)); }
    else if(n.type === "sim/Station"){ sim.addEntity(new Station(sim, n)); }
    else if(n.type === "sim/Join2"){ sim.addEntity(new Join2(sim, n)); }
    else if(n.type === "sim/Sink"){ sim.addEntity(new Sink(sim, n)); }
  }
  // 2) é…ç·š
  for(const id in graph.links){
    const L = graph.links[id];
    const a = sim.getEntity(L.origin_id);
    const b = sim.getEntity(L.target_id);
    if(a && b) a.out.push(b.id);
  }
  // 3) åˆæœŸåŒ–
  sim.reset();
  // 4) è‡ªå‹•é–‹å§‹ï¼ˆSourceã®startï¼‰
  for(const e of sim.entities.values()){
    if(e instanceof Source){ e.start(); }
  }
  // 5) ãƒœãƒˆãƒ«ãƒãƒƒã‚¯æ¨å®š
  let tmax = 0;
  for(const e of sim.entities.values()){
    if(e instanceof Station || e instanceof Join2){
      const tau = (e.tauP||0)+(e.tauT||0);
      tmax = Math.max(tmax, tau);
    }
  }
  document.getElementById("st_bneck").textContent = tmax? (fmt(tmax,2)+" s") : "-";
}

// ---------- UI ----------
const sim = new Simulation();

function runLoop(){
  if(!sim.sched.running) return;
  const speed = Number(document.getElementById("speed").value);
  sim.sched.horizon = Number(document.getElementById("horizon").value);
  // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã§è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ï¼ˆé€Ÿåº¦Ã—ï¼‰
  const MAX_PER_FRAME = 500 * speed;
  sim.sched.step(MAX_PER_FRAME);

  // çµ±è¨ˆæ›´æ–°
  document.getElementById("st_time").textContent = fmt(sim.sched.t,2)+" s";
  const q = sim.sched.t>0 ? sim.done / sim.sched.t : 0;
  document.getElementById("st_done").textContent = String(sim.done);
  document.getElementById("st_q").textContent = fmt(q,5)+" /s";
  document.getElementById("st_wip").textContent = String(sim.totalWIP());

  if(sim.sched.running && sim.sched.t <= sim.sched.horizon && sim.sched.events.length>0){
    requestAnimationFrame(runLoop);
  }else{
    sim.sched.running = false;
  }
}

// Buttons
document.getElementById("btnCompile").onclick = ()=>{
  compileGraph(sim);
  alert("ã‚°ãƒ©ãƒ•ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã—ãŸã€‚å·¦ä¸Šã®ã€èµ°ã‚‰ã›ã‚‹ã€ã§å®Ÿè¡Œã§ãã¾ã™ã€‚");
};
document.getElementById("btnRun").onclick = ()=>{
  if(sim.entities.size===0){ compileGraph(sim); }
  sim.sched.running = true;
  requestAnimationFrame(runLoop);
};
document.getElementById("btnPause").onclick = ()=>{ sim.sched.running=false; };
document.getElementById("btnReset").onclick = ()=>{
  sim.reset();
  document.getElementById("st_time").textContent = "0.00 s";
  document.getElementById("st_done").textContent = "0";
  document.getElementById("st_q").textContent = "0 /s";
  document.getElementById("st_wip").textContent = "0";
};

document.getElementById("btnSave").onclick = ()=>{
  const data = JSON.stringify(graph.serialize(), null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "graph.json";
  a.click();
};
document.getElementById("btnLoad").onclick = ()=>{
  const inp = document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange = (ev)=>{
    const f = ev.target.files[0];
    const fr = new FileReader();
    fr.onload = ()=>{
      graph.clear();
      graph.configure(JSON.parse(fr.result));
      graph.start();
    };
    fr.readAsText(f);
  };
  inp.click();
};

// ---------- ã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆ ----------
function clearAndCenter(){
  graph.clear();
  canvas.ds.offset = [0,0]; canvas.ds.scale=1.1;
}
document.getElementById("btnSampleLine").onclick = ()=>{
  clearAndCenter();
  const s = LiteGraph.createNode("sim/Source"); s.pos=[10,80]; s.properties.period=4;
  const a = LiteGraph.createNode("sim/Station"); a.pos=[220,60]; a.properties.tauP=5; a.properties.tauT=3;
  const b = LiteGraph.createNode("sim/Station"); b.pos=[420,60]; b.properties.tauP=4; b.properties.tauT=4;
  const k = LiteGraph.createNode("sim/Sink");    k.pos=[640,60];
  graph.add(s); graph.add(a); graph.add(b); graph.add(k);
  s.connect(0,a,0); a.connect(0,b,0); b.connect(0,k,0);
};

document.getElementById("btnSampleBranch").onclick = ()=>{
  clearAndCenter();
  const s = LiteGraph.createNode("sim/Source"); s.pos=[10,120]; s.properties.period=3;
  const a = LiteGraph.createNode("sim/Station"); a.pos=[220,120]; a.properties.tauP=4; a.properties.tauT=2; a.properties.routing="roundrobin";
  const b1= LiteGraph.createNode("sim/Station"); b1.pos=[440,40];  b1.properties.tauP=5; b1.properties.tauT=2;
  const b2= LiteGraph.createNode("sim/Station"); b2.pos=[440,200]; b2.properties.tauP=6; b2.properties.tauT=3;
  const k = LiteGraph.createNode("sim/Sink");    k.pos=[660,120];
  graph.add(s); graph.add(a); graph.add(b1); graph.add(b2); graph.add(k);
  s.connect(0,a,0); a.connect(0,b1,0); a.connect(0,b2,0); b1.connect(0,k,0); b2.connect(0,k,0);
};

document.getElementById("btnSampleJoin").onclick = ()=>{
  clearAndCenter();
  const s = LiteGraph.createNode("sim/Source"); s.pos=[10,120]; s.properties.period=3;
  const a1= LiteGraph.createNode("sim/Station"); a1.pos=[220,40];  a1.properties.tauP=3; a1.properties.tauT=2;
  const a2= LiteGraph.createNode("sim/Station"); a2.pos=[220,200]; a2.properties.tauP=4; a2.properties.tauT=2.5;
  const j = LiteGraph.createNode("sim/Join2");   j.pos=[440,120];  j.properties.tauP=2; j.properties.tauT=1;
  const b = LiteGraph.createNode("sim/Station"); b.pos=[660,120];  b.properties.tauP=5; b.properties.tauT=3;
  const k = LiteGraph.createNode("sim/Sink");    k.pos=[880,120];
  graph.add(s); graph.add(a1); graph.add(a2); graph.add(j); graph.add(b); graph.add(k);
  s.connect(0,a1,0); s.connect(0,a2,0); a1.connect(0,j,0); a2.connect(0,j,1); j.connect(0,b,0); b.connect(0,k,0);
};

// åˆæœŸã‚µãƒ³ãƒ—ãƒ«
document.getElementById("btnSampleLine").click();

// --------- ç›£è¦–ï¼šãƒãƒ¼ãƒ‰æç”»ã«çŠ¶æ…‹ãƒãƒƒã‚¸ï¼ˆç°¡æ˜“ï¼‰ ----------
const drawNodeOverlay = canvas.drawNode;
canvas.drawNode = function(canvas_ctx, node, other){
  drawNodeOverlay.call(this, canvas_ctx, node, other);
  const ent = sim.getEntity(node.id);
  if(!ent) return;
  const s = (ent instanceof Station||ent instanceof Join2) ? ent.state : (ent instanceof Source? (ent.active?"active":"idle") : "");
  if(!s) return;
  canvas_ctx.save();
  canvas_ctx.fillStyle = "#00000088";
  canvas_ctx.fillRect(node.size[0]-64, 0, 64, 20);
  canvas_ctx.fillStyle = "#d6e1ff";
  canvas_ctx.font = "12px monospace";
  canvas_ctx.fillText(s, node.size[0]-58, 14);
  canvas_ctx.restore();
};

// --------- å®Ÿè¡Œãƒ«ãƒ¼ãƒ—é–‹å§‹ãƒ»ã‚°ãƒ©ãƒ•èµ·å‹• ---------
graph.start();
</script>
</body>
</html>
